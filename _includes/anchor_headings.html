{% capture headingsWorkspace %}
    {% comment %}
        Version 1.0.0-RC3
          https://github.com/allejo/jekyll-headings

        "Be the pull request you wish to see in the world." ~Ben Balter

        Usage:
            {% include anchor_headings.html html=content %}

        Parameters:
            * html          (string) - the HTML of compiled markdown generated by kramdown in Jekyll

        Optional Parameters:
            * beforeHeading (bool)   : false  - Set to true if the anchor should be placed _before_ the heading's content
            * anchorBody    (string) :  ''    - The content that will be placed inside the anchor; the `%heading%` placeholder is available
            * anchorClass   (string) :  ''    - The class(es) that will be used for each anchor. Separate multiple classes with a space
            * anchorTitle   (string) :  ''    - The `title` attribute that will be used for anchors

        Output:
            The original HTML with the addition of anchors inside of all of the h1-h6 headings.
    {% endcomment %}

    {% assign beforeHeading = include.beforeHeading %}
    {% assign nodes = include.html | split: '<h' %}
    {% assign nodeCount = nodes | size %}

    {% capture edited_headings %}{% endcapture %}

    <!-- If nodeCount is less than 2, that means there were no headings -->
    {% if nodeCount >= 2 %}
        {% for node in nodes %}
            {% if node == "" %}
                {% continue %}
            {% endif %}

            {% assign headerLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}

            {% if headerLevel < 1 or headerLevel > 6 %}
                {% continue %}
            {% endif %}

            {% assign _workspace = node | split: '</h' %}
            {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
            {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
            {% assign html_id = _idWorkspace[0] %}

            {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
            {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}

            <!-- Build the anchor to inject for our heading -->
            {% capture anchor %}{% endcapture %}

            {% if html_id %}
                {% capture anchor %}href="#{{ html_id}}"{% endcapture %}

                {% if include.anchorClass %}
                    {% capture anchor %}{{ anchor }} class="{{ include.anchorClass }}"{% endcapture %}
                {% endif %}

                {% if include.anchorTitle %}
                    {% capture anchor %}{{ anchor }} title="{{ include.anchorTitle | replace: '%heading%', header }}"{% endcapture %}
                {% endif %}

                {% capture anchor %}<a {{ anchor }}>{{ include.anchorBody | replace: '%heading%', header | default: '' | raw }}</a>{% endcapture %}

                {% if beforeHeading %}
                    {% capture anchor %}{{ anchor }} {% endcapture %}
                {% else %}
                    {% capture anchor %} {{ anchor }}{% endcapture %}
                {% endif %}
            {% endif %}

            <!-- The placement of our anchor, before the heading content or after -->
            {% if beforeHeading %}
                {% capture _current %}<h{{ _hAttrToStrip | raw }}{{ anchor }}{% endcapture %}
                {% capture edited_headings %}{{ edited_headings }}{{ node | replace: _hAttrToStrip, _current | raw }}{% endcapture %}
            {% else %}
                {% capture _current %}<h{{ _workspace | first }}{{ anchor }}</h{{ _workspace | last }}{% endcapture %}
                {% capture edited_headings %}{{ edited_headings }}{{ _current }}{% endcapture %}
            {% endif %}
        {% endfor %}
    {% else %}
        {% capture edited_headings %}{{ include.html }}{% endcapture %}
    {% endif %}
{% endcapture %}{% assign headingsWorkspace = '' %}{{ edited_headings | strip }}
